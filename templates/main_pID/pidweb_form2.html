{% extends 'main_pID/base.html' %}
{% load static %}
{% load upload_tags %}
{% block content %}
<h4>pIDWeb - beta</h4>
<blockquote>
	<p>This is a beta version of PlasmidIDWeb. Server runs latest version of PlasmidID using a friendly interface and allows researchers to downlaod their results<br>
	Supports paired-end data from WGS experiments</p>
</blockquote>
<br>
<!-- The fileinput-button span is used to style the file input field as button -->
<div class="panel panel-default">
	<div class="panel-heading">Run pIDWeb</div>
		<div class="panel-body">
			<form id="fileupload" method="post" action="/pIDWeb" enctype="multipart/form-data">
				{% csrf_token %}
				<div class="row fileupload-buttonbar">
					<div class="col-lg-7">
						<!-- The fileinput-button span is used to style the file input field as button -->
						<span class="btn btn-success fileinput-button">
							<i class="glyphicon glyphicon-plus"></i>
							<span>Add files R1...</span>
							<input type="file" name="file_R1">
						</span>
						<span class="btn btn-success fileinput-button">
							<i class="glyphicon glyphicon-plus"></i>
							<span>Add files R2...</span>
							<input type="file" name="file_R2">
						</span>
						<button class="btn btn-primary start">
							<i class="glyphicon glyphicon-upload"></i>
							<span>Start upload</span>
						</button>
					</div>
				</div>
				<!-- The global progress bar -->
				<div id="progress" class="progress">
						<div class="progress-bar progress-bar-success"></div>
				</div>
				<!-- The table listing the files available for upload/download -->
    			<div id="f" class="files"></div>
				<!--<table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>-->
			</form>
		</div>
	</div>
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Notes</h3>
		</div>
		<div class="panel-body">
			<ul>
				<li>The maximum file size for uploads in this beta is <strong>4GB</strong></li>
				<li>Only fastq files (<strong>fastq or fastq.gz</strong>) are allowed.</li>
				<li>You can <strong>drag &amp; drop</strong> files from your desktop on this webpage (see <a href="https://github.com/blueimp/jQuery-File-Upload/wiki/Browser-support">Browser support</a>).</li>
			</ul>
		</div>
	</div>
</div>
<!--{% upload_js %}-->
<!-- The jQuery UI widget factory, can be omitted if jQuery UI is already included -->
<script src="{% static "/js/vendor/jquery.ui.widget.js" %}"></script>
<!-- The Templa static "tes plugin is included to render the upload/download listings -->
<script src="{% static "/js/tmpl.min.js" %}"></script>
<!-- The Load I static "mage plugin is included for the preview images and image resizing functionality -->
<script src="{% static "/js/load-image.min.js" %}"></script>
<!-- The Canvas static " to Blob plugin is included for image resizing functionality -->
<script src="{% static "/js/canvas-to-blob.min.js" %}"></script>
<!-- Bootstrap  static "JS is not required, but included for the responsive demo navigation -->
<script src="{% static "/js/bootstrap.min.js" %}"></script>
<!-- blueimp Ga static "llery script -->
<script src="{% static "/js/jquery.blueimp-gallery.min.js" %}"></script>
<!-- The Iframe static " Transport is required for browsers without support for XHR file uploads -->
<script src="{% static "/js/jquery.iframe-transport.js" %}"></script>
<!-- The basic  static "File Upload plugin -->
<script src="{% static "/js/jquery.fileupload.js" %}"></script>
<!-- The File U static "pload processing plugin -->
<script src="{% static "/js/jquery.fileupload-process.js" %}"></script>
<!-- The File U static "pload image preview & resize plugin -->
<script src="{% static "/js/jquery.fileupload-image.js" %}"></script>
<!-- The File U static "pload audio preview plugin -->
<script src="{% static "/js/jquery.fileupload-audio.js" %}"></script>
<!-- The File U static "pload video preview plugin -->
<script src="{% static "/js/jquery.fileupload-video.js" %}"></script>
<!-- The File U static "pload validation plugin -->
<script src="{% static "/js/jquery.fileupload-validate.js" %}"></script>
<!-- The File U static "pload user interface plugin -->
<!--<script src="{% static "/js/jquery.fileupload-ui.js" %}"></script>-->
<!-- The main a static "pplication script -->
<script src="{% static "/js/locale.js" %}"></script>
<script src="{% static "/js/csrf.js" %}"></script>
<script src="{% static "js/jquery.cookie.js" %}"></script>
<script>

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

$(document).ready(function(){
    var csrftoken = $.cookie('csrftoken');
    var filesList = [];
    paramNames = [];
    context = "";
    //elem = $("form");
    $("#fileupload").fileupload({
        url: '/pIDWeb',
        //crossDomain: false,
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type)) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        },
        dataType: 'json',
        autoUpload: false,
        maxNumberOfFiles: 2,
        sequentialUploads: true,
        acceptFileTypes: /(\.|\/)(pdf)$/i,
        maxFileSize: 4000000000, // 4G
        fileInput: $("input:file"),
    }).on('fileuploadadd', function(e, data){
        filesList.push(data.files[0]);
		//console.log(data.paramName);
        paramNames.push(data.paramName);
        data.context = $('<div/>').appendTo('#f');
        $.each(data.files, function (index, file) {
            var node = $('<p/>')
                    .append($('<span/>').text(file.name));
            node.appendTo(data.context);
        context = data.context;
    	});

    }).on('fileuploadprocessalways', function (e, data) {
        var index = data.index,
            file = data.files[index],
            node = $(data.context.children()[index]);
        if (file.preview) {
            node
                .prepend('<br>')
                .prepend(file.preview);
        }
        if (file.error) {
            node
                .append('<br>')
                .append(file.error);
        }
        if (index + 1 === data.files.length) {
            data.context.find('button')
                .text('Upload')
                .prop('disabled', !!data.files.error);
        }
    }).on('fileuploadprogressall', function (e, data) {
        var progress = parseInt(data.loaded / data.total * 100, 10);
        $('#progress .progress-bar').css(
            'width',
            progress + '%'
        );
    }).on('fileuploaddone', function (e, data) {
        $.each(data.result.files, function (index, file) {
            var node = $('<p/>')
                    .append($('<span/>').text("Upload succesfully completed!"));
            node.appendTo(data.context);
			//console.log(data)
			//debugger;
        });
    }).on('fileuploadfail', function (e, data) {
        $.each(data.result.files, function (index, file) {
            var error = $('<span/>').text(file.error);
            $(data.context.children()[index])
                .append('<br>')
                .append(error);
        });
    }).prop('disabled', !$.support.fileInput)
        .parent().addClass($.support.fileInput ? undefined : 'disabled');

    $("button").click(function(e){
        e.preventDefault();
		console.log(filesList);
        $('#fileupload').fileupload('send', {files:filesList, paramName: paramNames,context:context});
    });
});
</script>
{% endblock %}
